name: Build and Release

# ワークフロー実行のトリガー
on:
  push:
    # main ブランチへのプッシュで自動実行
    branches: [ main ]
    # タグでリリースをトリガーしたい場合は以下を有効化
    # tags: ['v*']
  workflow_dispatch: {}

# 環境変数
env:
  LATEX_BUILD_DIR: latex
  STARTER_KIT_DIR: starter-kit
  ARTIFACTS_DIR: artifacts

jobs:
  # PDF ビルドジョブ: Makefile または pdflatex で guide.tex をビルド
  # キャッシュ: TeX Live の auxiliary ディレクトリをキャッシュして高速化
  build_pdf:
    runs-on: ubuntu-latest
    # 並列実行される複数ジョブの一つ
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache TeXLive auxiliary directories
        # TeXLive の大きなインストールの再利用を試みるためのキャッシュ
        uses: actions/cache@v4
        with:
          path: |
            ~/.texmf-var
            ~/.texlive*
          key: ${{ runner.os }}-tex-${{ hashFiles('latex/**', 'templates/**') }}

      - name: Install TeX Live with XeLaTeX and Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-xetex texlive-latex-extra texlive-fonts-recommended \
            texlive-lang-japanese texlive-fonts-extra texlive-luatex \
            latexmk fonts-noto-cjk fonts-ipafont fonts-liberation

      - name: Build guide.pdf (Makefile を使用、XeLaTeX で日本語対応)
        working-directory: latex
        run: |
          # Makefile が存在する場合は make を使用、なければ直接 xelatex を実行
          if [ -f Makefile ]; then
            echo "Makefile found. Using make pdf..."
            make pdf || true
          else
            echo "Makefile not found. Using direct xelatex..."
            xelatex -interaction=nonstopmode -halt-on-error=false guide.tex || true
            xelatex -interaction=nonstopmode -halt-on-error=false guide.tex || true
          fi

      - name: Verify PDF output
        run: |
          if [ -f latex/guide.pdf ]; then
            echo "✓ PDF generated successfully"
            ls -lh latex/guide.pdf
          else
            echo "✗ PDF not found"
            exit 1
          fi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: guide-pdf
          path: latex/guide.pdf

  # ZIP 作成ジョブ: 改善済みスクリプトを使用して starter-kit をアーカイブ
  build_zip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create ZIP directly (簡潔版)
        run: |
          # 出力ディレクトリ作成
          mkdir -p output
          
          # starter-kit フォルダを ZIP に圧縮
          echo "Creating ZIP from starter-kit folder..."
          zip -r -q output/starter-kit.zip starter-kit -x "starter-kit/.git/*" "starter-kit/.env" || {
            echo "Error: ZIP creation failed"
            ls -la starter-kit/
            exit 1
          }
          
          # 結果確認
          echo "=== ZIP created successfully ==="
          ls -lh output/starter-kit.zip
          
          # ZIP 内容確認
          echo ""
          echo "=== ZIP file contents ==="
          unzip -l output/starter-kit.zip | head -20

      - name: Upload ZIP artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: starter-kit-zip
          path: output/starter-kit.zip
          if-no-files-found: warn

  # リリース作成ジョブ: PDF と ZIP をダウンロードして GitHub Release にアップロード
  release:
    needs: [build_pdf, build_zip]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for metadata)
        uses: actions/checkout@v4

      - name: Download PDF artifact
        uses: actions/download-artifact@v4
        with:
          name: guide-pdf
          path: artifacts

      - name: Download ZIP artifact
        id: download_zip
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: starter-kit-zip
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -lh artifacts/ || echo "No artifacts found"

      - name: Prepare release files
        run: |
          mkdir -p release_files
          
          # PDF をコピー
          if [ -f artifacts/guide.pdf ]; then
            cp artifacts/guide.pdf release_files/
            echo "✓ PDF copied"
          else
            echo "✗ PDF not found"
          fi
          
          # ZIP をコピー（存在する場合）
          if ls artifacts/starter-kit*.zip 1> /dev/null 2>&1; then
            cp artifacts/starter-kit*.zip release_files/
            echo "✓ ZIP copied"
          else
            echo "⚠ ZIP not found (will create release with PDF only)"
          fi
          
          echo ""
          echo "=== Release files ready ==="
          ls -lh release_files/

      - name: Create GitHub Release with assets
        id: create_release
        continue-on-error: true
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          draft: false
          prerelease: false
          body: |
            ## 自動生成リリース
            
            このリリースには以下が含まれています:
            - `guide.pdf` - LaTeX でビルドされたドキュメント
            - `starter-kit.zip` - starter-kit アーカイブ
            
            ワークフロー実行: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          files: |
            release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: always()
        run: |
          echo "=== Release Summary ==="
          echo ""
          if [ -d release_files ]; then
            echo "Release files:"
            ls -lh release_files/
          else
            echo "No release_files directory"
          fi
          
          if [ -f release_files/guide.pdf ]; then
            echo "✓ PDF found"
          else
            echo "✗ PDF NOT found"
          fi
          
          if ls release_files/starter-kit*.zip 1>/dev/null 2>&1; then
            echo "✓ ZIP found"
          else
            echo "⚠ ZIP not found"
          fi
