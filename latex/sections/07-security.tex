% 07-security.tex
% ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚»ã‚¯ã‚·ãƒ§ãƒ³

\chapter{ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹}

\section{æ¦‚è¦}

æœ¬ç•ªç’°å¢ƒã«ãŠã‘ã‚‹ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€ã‚³ãƒ³ãƒ†ãƒŠã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯æœ€å„ªå…ˆã§ã™ã€‚æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯å®Ÿè£…æ¸ˆã¿ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’è©³è¿°ã—ã¾ã™ã€‚

\section{ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†}

\subsection{GitHub Secrets}

\begin{lstlisting}[language=yaml,caption=ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå‚ç…§ï¼ˆå®‰å…¨ï¼‰]
# build.yml ã§ã®ä½¿ç”¨æ–¹æ³•

# âœ“ æ­£ã—ã„æ–¹æ³•ï¼šã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å‚ç…§
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  deploy:
    steps:
      - name: Deploy
        env:
          # âœ“ ã‚¹ãƒ†ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå‚ç…§
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          # âœ— ãƒ­ã‚°å‡ºåŠ›ç¦æ­¢
          # echo $DOCKER_PASSWORD
          
          # âœ“ ãƒã‚¹ã‚¯å‡¦ç†
          echo "::add-mask::$DOCKER_PASSWORD"
\end{lstlisting}

\subsection{ç’°å¢ƒå¤‰æ•°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ}

\begin{table}[h]
\centering
\begin{tabularx}{\textwidth}{|l|X|X|}
\hline
\textbf{ã‚¿ã‚¤ãƒ—} & \textbf{ç”¨é€”} & \textbf{ç®¡ç†æ–¹æ³•} \\
\hline
ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ & ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒˆãƒ¼ã‚¯ãƒ³ã€API ã‚­ãƒ¼ & GitHub Secrets \\
ç’°å¢ƒå¤‰æ•° & ãƒ“ãƒ«ãƒ‰è¨­å®šã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« & .env ãƒ•ã‚¡ã‚¤ãƒ« \\
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« & ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š & config/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª \\
\hline
\end{tabularx}
\caption{æƒ…å ±ç®¡ç†ã®åˆ†é¡}
\end{table}

\section{Docker ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£}

\subsection{ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰}

\begin{lstlisting}[language=dockerfile,caption=ã‚»ã‚­ãƒ¥ã‚¢ãª ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰]
# ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ï¼ˆé–‹ç™ºãƒ„ãƒ¼ãƒ«å«ã‚€ï¼‰
FROM python:3.11-slim as builder

WORKDIR /build

# ãƒ“ãƒ«ãƒ‰ä¾å­˜ï¼ˆæœ¬ç•ªã§ã¯ä¸è¦ï¼‰
RUN apt-get update && apt-get install -y gcc g++ make

COPY requirements.txt .
RUN pip install -r requirements.txt

# ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆæœ€å°é™ï¼‰
FROM python:3.11-slim

# éãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN groupadd -r appuser && useradd -r -g appuser appuser

COPY --from=builder /usr/local/lib/python3.11/site-packages \
  /usr/local/lib/python3.11/site-packages

USER appuser  # éãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ

CMD ["python", "main.py"]
\end{lstlisting}

\subsection{ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯}

\begin{lstlisting}[language=yaml,caption=trivy ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒ£ãƒ³]
- name: Scan Docker Image with Trivy
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'copilot-automation:latest'
    format: 'sarif'
    output: 'trivy-results.sarif'

- name: Upload Trivy results
  uses: github/codeql-action/upload-sarif@v2
  with:
    sarif_file: 'trivy-results.sarif'
\end{lstlisting}

\section{ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£}

\subsection{HTTPS å¼·åˆ¶}

\begin{lstlisting}[language=yaml,caption=HTTPS ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å¼·åˆ¶]
jobs:
  deploy:
    steps:
      - name: Verify HTTPS
        run: |
          # URL ã‚¹ã‚­ãƒ¼ãƒ æ¤œè¨¼
          if [[ ! "$WEBHOOK_URL" =~ ^https:// ]]; then
            echo "âœ— HTTPS ãŒå¿…é ˆã§ã™"
            exit 1
          fi
          echo "âœ“ HTTPS ç¢ºèªå®Œäº†"
        env:
          WEBHOOK_URL: ${{ secrets.POWER_AUTOMATE_WEBHOOK }}
\end{lstlisting}

\subsection{API ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³}

\begin{itemize}
  \item \textbf{å®šæœŸå®Ÿè¡Œ}: 30-90 æ—¥ã”ã¨
  \item \textbf{ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•}: æ–°ã‚­ãƒ¼è¿½åŠ  â†’ å¤ã‚­ãƒ¼å‰Šé™¤ â†’ å†ãƒ‡ãƒ—ãƒ­ã‚¤
  \item \textbf{è‡ªå‹•åŒ–}: GitHub Actions ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  \item \textbf{ç›£æŸ»}: å…¨ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ“ä½œã‚’ãƒ­ã‚°è¨˜éŒ²
\end{itemize}

\section{ã‚³ãƒ¼ãƒ‰ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£}

\subsection{ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯}

\begin{lstlisting}[language=yaml,caption=Dependabot ã«ã‚ˆã‚‹è„†å¼±æ€§æ¤œå‡º]
# .github/dependabot.yml
version: 2
updates:
  # Python ä¾å­˜é–¢ä¿‚
  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "daily"
    security-updates-only: true
    reviewers:
      - "security-team"

  # Docker ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸
  - package-ecosystem: "docker"
    directory: "/"
    schedule:
      interval: "weekly"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
\end{lstlisting}

\subsection{SAST (Static Application Security Testing)}

\begin{lstlisting}[language=yaml,caption=CodeQL ã«ã‚ˆã‚‹è„†å¼±æ€§è§£æ]
- name: Initialize CodeQL
  uses: github/codeql-action/init@v2
  with:
    languages: 'python'

- name: Run CodeQL analysis
  uses: github/codeql-action/analyze@v2

- name: Upload CodeQL results
  uses: github/codeql-action/upload-sarif@v2
  with:
    sarif_file: 'codeql-results.sarif'
\end{lstlisting}

\section{ãƒ­ã‚°ã¨ç›£æŸ»}

\subsection{ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²}

\begin{lstlisting}[language=python,caption=Python ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°]
import logging
import json
from datetime import datetime

# ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ­ã‚®ãƒ³ã‚°è¨­å®š
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('security.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def log_security_event(event_type, user, action, result):
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆ ãƒ­ã‚®ãƒ³ã‚°"""
    log_entry = {
        'timestamp': datetime.utcnow().isoformat(),
        'event_type': event_type,
        'user': user,
        'action': action,
        'result': result
    }
    logger.info(json.dumps(log_entry))

# ä½¿ç”¨ä¾‹
log_security_event(
    event_type='deployment',
    user='github-actions',
    action='push_docker_image',
    result='success'
)
\end{lstlisting}

\subsection{ç›£æŸ»ãƒˆãƒ¬ã‚¤ãƒ«}

\begin{itemize}
  \item \textbf{GitHub}: Settings â†’ Audit log ã§å…¨æ“ä½œã‚’ç›£è¦–
  \item \textbf{Docker}: GHCR â†’ Package settings ã§ push/pull ãƒ­ã‚°ã‚’ç¢ºèª
  \item \textbf{OneDrive}: SharePoint â†’ Site contents ã§ ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´è¿½è·¡
  \item \textbf{Power Automate}: Run history ã§ ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå±¥æ­´ç¢ºèª
\end{itemize}

\section{ãƒªã‚¹ã‚¯è©•ä¾¡ã¨å¯¾å¿œ}

\subsection{ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯è¡Œåˆ—}

\begin{table}[h]
\centering
\begin{tabularx}{\textwidth}{|l|l|l|l|}
\hline
\textbf{ãƒªã‚¹ã‚¯} & \textbf{å½±éŸ¿} & \textbf{å¯èƒ½æ€§} & \textbf{å¯¾å¿œ} \\
\hline
ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´© & ğŸ”´ è‡´å‘½çš„ & ä¸­ & GitHub Secrets \\
è„†å¼±æ€§ in deps & ğŸŸ  é«˜ & é«˜ & Dependabot \\
ç„¡è¨±å¯ã‚¢ã‚¯ã‚»ã‚¹ & ğŸ”´ è‡´å‘½çš„ & ä½ & 2FA, OIDC \\
DoS æ”»æ’ƒ & ğŸŸ¡ ä¸­ & ä½ & ãƒ¬ãƒ¼ãƒˆåˆ¶é™ \\
\hline
\end{tabularx}
\caption{ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯è©•ä¾¡}
\end{table}

\section{ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹}

\subsection{ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ}

\begin{itemize}
  \item \checkbox{} GitHub Secret ã§å…¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†
  \item \checkbox{} Docker ã‚¤ãƒ¡ãƒ¼ã‚¸å®šæœŸã‚¹ã‚­ãƒ£ãƒ³ (Trivy)
  \item \checkbox{} Dependabot æœ‰åŠ¹åŒ–
  \item \checkbox{} CodeQL åˆ†æå®Ÿè¡Œ
  \item \checkbox{} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
  \item \checkbox{} ç›£æŸ»ãƒˆãƒ¬ã‚¤ãƒ«ç¢ºèª
  \item \checkbox{} API ã‚­ãƒ¼ 90 æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
  \item \checkbox{} HTTPS ã®ã¿ä½¿ç”¨
  \item \checkbox{} éãƒ«ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œ
  \item \checkbox{} ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³æœ€å°åŒ– (RBAC)
\end{itemize}

\note{æœ¬ç•ªç’°å¢ƒã§ã¯å…¨é …ç›®ã‚’ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«ã—ã¦ãã ã•ã„ã€‚}
